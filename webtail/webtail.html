<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Localize "Log Viewer"}}</title>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }

        body {
            background-color: #0d1117;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #container {
            height: calc(100vh - 20px);
            width: calc(100vw - 20px);
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
        }

        #filter-bar {
            display: flex;
            gap: 8px;
            padding: 10px;
            background-color: #1e1e1e;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            align-items: center;
        }

        .logtype-select-container {
            position: relative;
            min-width: 180px;
        }

        .logtype-select-button {
            padding: 8px 12px;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 6px;
            color: white;
            font-family: '{{.Ext.ControlBar.FontFamily}}';
            font-size: {{.Ext.ControlBar.FontSize}}px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        #logtype-select-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            margin-right: 8px;
        }

        .logtype-select-button:hover {
            background-color: #3d3d3d;
        }

        .logtype-select-button:focus {
            outline: none;
            border-color: #0078d4;
        }

        .logtype-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            max-height: 250px;
            overflow-y: auto;
        }

        .logtype-select-dropdown.open {
            display: block;
        }

        .logtype-option {
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .logtype-option:hover {
            background-color: #3d3d3d;
        }

        .logtype-option input[type="checkbox"] {
            cursor: pointer;
            width: calc({{.Ext.ControlBar.FontSize}}px + 2px);
            height: calc({{.Ext.ControlBar.FontSize}}px + 2px);
        }

        .logtype-option label {
            cursor: pointer;
            flex: 1;
            font-size: {{.Ext.ControlBar.FontSize}}px;
        }

        .arrow-down {
            border: solid white;
            border-width: 0 2px 2px 0;
            display: inline-block;
            padding: 3px;
            transform: rotate(45deg);
            -webkit-transform: rotate(45deg);
            transition: transform 0.2s;
        }

        .arrow-down.open {
            transform: rotate(-135deg);
            -webkit-transform: rotate(-135deg);
        }

        #filter-input {
            flex: 1;
            padding: 8px 12px;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 6px;
            color: white;
            font-family: '{{.Ext.ControlBar.FontFamily}}';
            font-size: {{.Ext.ControlBar.FontSize}}px;
        }

        #filter-input:focus {
            outline: none;
            border-color: #0078d4;
        }

        .filter-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-family: '{{.Ext.ControlBar.FontFamily}}';
            font-size: {{.Ext.ControlBar.FontSize}}px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #apply-btn {
            background-color: #0078d4;
            color: white;
        }

        #apply-btn:hover {
            background-color: #005a9e;
        }

        #clear-btn {
            background-color: #444;
            color: white;
        }

        #clear-btn:hover {
            background-color: #555;
        }

        #terminal {
            flex: 1;
            min-height: 0;
            padding: 8px;
            background-color: {{.Terminal.Theme.Background}};
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            user-select: none;
            /* Disable text selection */
            -ms-user-select: none;
            /* IE 10+ */
            -moz-user-select: none;
            /* Firefox */
            -webkit-user-select: none;
            /* Safari */
        }
    </style>
</head>

<body>
    <!-- Container for filter bar and terminal -->
    <div id="container">
        <!-- Filter bar -->
        {{ if not .Ext.ControlBar.Hide }}
        <div id="filter-bar">
            <!-- Log Multi-Select -->
            {{if gt (len .Ext.Files) 1 }}
            <div class="logtype-select-container">
                <button class="logtype-select-button" id="logtype-select-btn">
                    <span id="logtype-select-text">{{ .Localize "All Logs" }}</span>
                    <span class="arrow-down" id="logtype-arrow"></span>
                </button>
                <div class="logtype-select-dropdown" id="logtype-dropdown">
                    {{ range $f := .Ext.Files }}
                    <div class="logtype-option">
                        <input type="checkbox" id="{{$f.ID}}" value="{{$f.Label}}" checked>
                        <label for="{{$f.ID}}">{{$f.Label}}</label>
                    </div>
                    {{ end }}
                </div>
            </div>
            {{end}}
            <input type="text" id="filter-input" placeholder="{{ .Localize "Enter filter text..."}}" />
            <button id="apply-btn" class="filter-btn">{{ .Localize "Apply"}}</button>
            <button id="clear-btn" class="filter-btn">{{ .Localize "Clear"}}</button>
        </div>
        {{ end }}

        <!-- Terminal container -->
        <div id="terminal"></div>
    </div>

    <!-- Xterm.js CSS & JS -->
    <link rel="stylesheet" href="xterm.css" />
    <script src="xterm.js"></script>
    <script src="addon-fit.min.js"></script>
    <script src="addon-attach.min.js"></script>
    <script src="addon-webgl.min.js"></script>
    <!-- WebTerm CSS & JS -->
    <link rel="stylesheet" href="webterm.css" />
    <script src="webterm.js"></script>
    <script>
        let term = WebTerm("terminal", {{ .Terminal.ToJSON }});

        // Log type select dropdown controls
        const logtypeSelectBtn = document.getElementById('logtype-select-btn');
        const logtypeDropdown = document.getElementById('logtype-dropdown');
        const logtypeSelectText = document.getElementById('logtype-select-text');
        const logtypeArrow = document.getElementById('logtype-arrow');
        const logtypeCheckboxes = document.querySelectorAll('.logtype-option input[type="checkbox"]');

        // Toggle dropdown
        if( logtypeSelectBtn ) {
            logtypeSelectBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                logtypeDropdown.classList.toggle('open');
                logtypeArrow.classList.toggle('open');
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!logtypeSelectBtn.contains(e.target) && !logtypeDropdown.contains(e.target)) {
                logtypeDropdown.classList.remove('open');
                logtypeArrow.classList.remove('open');
            }
        });

        // Update button text when checkboxes change
        function updateLogtypeSelectText() {
            const selected = Array.from(logtypeCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            if (selected.length === 0) {
                logtypeSelectText.textContent = '{{ .Localize "No Logs"}}';
            } else if (selected.length === logtypeCheckboxes.length) {
                logtypeSelectText.textContent = '{{ .Localize "All Logs" }}';
            } else {
                logtypeSelectText.textContent = selected.join(', ');
            }
        }

        logtypeCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateLogtypeSelectText);
        });

        // Get selected log types
        function getSelectedFileIDs() {
            return Array.from(logtypeCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.id);
        }

        // Filter controls
        const filterInput = document.getElementById('filter-input');
        const applyBtn = document.getElementById('apply-btn');
        const clearBtn = document.getElementById('clear-btn');

        applyBtn.addEventListener('click', () => {
            const filter = filterInput.value.trim();
            const selected = getSelectedFileIDs();
            term.send(2, JSON.stringify({ filter: filter, files: selected }));
        });

        clearBtn.addEventListener('click', () => {
            filterInput.value = '';
            // Reset all checkboxes to checked
            logtypeCheckboxes.forEach(cb => cb.checked = true);
            updateLogtypeSelectText();
            term.send(2, JSON.stringify({ files: getSelectedFileIDs() }));
        });

        // Allow Enter key to apply filter
        filterInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const filter = filterInput.value.trim();
                const selected = getSelectedFileIDs();
                term.send(2, JSON.stringify({ filter: filter, files: selected }));
            }
        });
    </script>
</body>

</html>